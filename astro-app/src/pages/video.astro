---
import Card from "../components/Card.astro";
import Layout from "../layouts/Layout.astro";
import { getTastes } from "../utils/sanity";
import { getFullVideo } from '../utils/sanity';

const tastes = await getTastes();
const fullVideo = await getFullVideo();
---

<Layout title="Video - ION Break">
  <section>
    <button id="back-button" aria-label="Back Button" onclick="history.back()">
      <img
        src="/img/Button_Close.png"
        alt="Close Button"
        class="video-button-img"
      />
    </button>
    
    <svg style="position: absolute; width: 0; height: 0;" aria-hidden="true">
      <defs>
        <clipPath id="videoClip" clipPathUnits="objectBoundingBox">
          <polygon points="0.0911,0.0203 0.1064,0.0959 0.1064,0.2275 0.0911,0.2901 0.0911,0.3657 0.1064,0.4732 0.1028,0.5905 0.0775,0.7786 0.0522,0.8877 0.1318,0.9584 0.2537,0.9681 0.3476,0.9423 0.4633,0.8989 0.7056,0.9122 0.8081,0.9507 0.8683,1 0.9479,0.9294 0.9177,0.8480 0.9225,0.4326 0.9033,0.2077 0.9177,0.1371 0.8911,0 0.8236,0.0278 0.7045,0.0407 0.6419,0.0578 0.5371,0.0429 0.4600,0.0600 0.4600,0 0.3805,0 0.3178,0.0343 0.2010,0.0450 0.1203,0"/>
        </clipPath>
      </defs>
    </svg>

    <div id="video-container">
      <div id="video-wrapper">
        {fullVideo && (fullVideo.videoFile || fullVideo.videoUrl) && (
          <video
            id="full-video"
            autoplay
            loop
            playsinline
            poster={fullVideo.posterImage}
          >
            <source src={fullVideo.videoUrl || fullVideo.videoFile} type="video/mp4" />
          </video>
        )}
      </div>

      <div id="video-frame-container">
        <img
          src="/img/Player_Frame.png"
          alt="Player Frame"
          id="video-frame"
        />
      </div>
    </div>

    <button id="video-play-button" class="video-button" aria-label="Play/Pause Video">
      <img
        src="/img/Button_Play.png"
        alt="Player Frame"
        class="video-button-img"
      />
    </button>

    <button id="video-mute-button" class="video-button" aria-label="Mute/Unmute Video">
      <img
        src="/img/Button_Mute.png"
        alt="Player Frame"
        class="video-button-img"
      />
    </button>
  </section>
</Layout>

<script is:inline>
  document.addEventListener('astro:page-load', () => {
    const video = document.getElementById('full-video');
    const playButton = document.getElementById('video-play-button');
    const muteButton = document.getElementById('video-mute-button');

    if (video && playButton) {
      playButton.onclick = () => {
        if (video.paused) {
          video.play();
        } else {
          video.pause();
        }
      };
    }

    if (video && muteButton) {
      muteButton.onclick = () => {
        // Fix específico para Chrome
        if (video.muted) {
          // Desmutear: hack para Chrome
          const tempVolume = video.volume || 1;
          video.volume = 0;
          video.muted = false;
          
          // Fade in rápido para evitar el freeze
          let vol = 0;
          const fadeIn = setInterval(() => {
            if (vol < tempVolume) {
              vol += 0.1;
              video.volume = Math.min(vol, tempVolume);
            } else {
              clearInterval(fadeIn);
            }
          }, 10);
        } else {
          // Mutear: directo
          video.muted = true;
        }
      };
    }
  });
</script>

<style>
  #video-container {
    position: fixed;
    top: 45%;
    left: 50%;
    transform: translate(-50%, -50%);
    height: 85dvh;
  }

  #video-wrapper {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-52%, -50%);
    height: 69%;
    width: auto;
  }

  #full-video {
    height: 100%;
    width: auto;
    clip-path: url(#videoClip);
  }

  #video-frame-container {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    height: 100%;
    pointer-events: none;
    line-height: 0;
  }

  #video-frame,
  .video-button-img {
    height: 100%;
    width: auto;
  }

  .video-button {
    position: fixed;
    bottom: 9%;
    height: 15dvh;
    width: auto;
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    z-index: 10;
  }

  #video-play-button {
    left: calc(50% - 76vh);
    transform: translateX(150%);
  }

  #video-mute-button {
    right: calc(50% - 76vh);
    transform: translateX(-150%);
  }

  #video-mute-button:hover img {
    transform: rotate(5deg) scale(1.03);
  }

  #video-mute-button:hover:active img {
    transform: rotate(7deg) scale(1.05);
  }

  #video-play-button:hover img {
    transform: rotate(-7deg) scale(.95);
  }

  #video-play-button:hover:active img {
    transform: rotate(-10deg) scale(1);
  }

  #back-button {
    position: fixed;
    top: 0;
    left: 0;
    transform: translate(-10%, 8%);
    height: 11dvh;
    width: auto;
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    z-index: 10;
  }

  #back-button:hover img {
    transform: rotate(-6deg) scale(.97);
  }

  #back-button:hover:active img {
    transform: rotate(-8deg) scale(.92);
  }

  @media screen and (max-aspect-ratio: 1/1) {
    #video-container {
      height: auto;
      width: 100vw;
      top: 50%;
    }

    #video-wrapper {
      width: 92%;
      height: auto;
    }

    #video-frame-container,
    #full-video,
    #video-frame {
      width: 100%;
      height: auto;
    }

    #video-frame {
      width: 100%;
      height: auto;
    }

    .video-button-img {
      height: auto;
      width: 100%;
    }

    #back-button .video-button-img {
      height: 100%;
      width: auto;
    }

    #video-play-button,
    #video-mute-button {
      bottom: calc(50% - 26.5vw);
      transform: translateY(110%);
      width: 25vw;
      height: auto;
    }

    #video-play-button {
      left: 6vw;
    }

    #video-mute-button {
      right: 6vw;
    }
  }

  @media screen and (max-aspect-ratio: 3/4) {
    #back-button {
      top: auto;
      left: auto;
      bottom: 0;
      right: 0;
      width: 25vw;
      height: auto;
      transform: translate(8%, -8%);
    }

    #back-button .video-button-img {
      height: auto;
      width: 100%;
    }
  }
</style>